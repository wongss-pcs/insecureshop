name: CI for insecure shop build

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:

    build-and-analyze:
        permissions:
            # required for all workflows
            security-events: write

            # required to fetch internal or private CodeQL packs
            packages: read

            # only required for workflows in private repositories
            actions: read
            contents: read
   
        strategy:
            fail-fast: false
            matrix:
                language: ["java-kotlin"]
                build-mode: [ "manual" ] 
                queries: [ "security-extended", "security-and-quality" ]

        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - uses: actions/cache@v2
              with:
                path: |
                    ~/.gradle/caches
                    ~/.gradle/wrapper
                key: ${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/buildSrc/**/*.kt') }}

            - name: Set up JDK
              uses: actions/setup-java@v3
              with:
                distribution: 'temurin'
                java-version: '17'

            - name: Build debug APK
              run: ./gradlew assemble

            # Initializes the CodeQL tools for scanning.
            - name: Initialize CodeQL
              uses: github/codeql-action/init@v3
              with:
                languages: ${{ matrix.language }}
                queries: ${{ matrix.queries }}

            - if: matrix.build-mode == 'manual'
              shell: bash
              run: |
                ./gradlew assemble
                exit 0
          
            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3
              with:
                category: "/language:${{matrix.language}}"
